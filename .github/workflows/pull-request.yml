name: Pull Request Checks

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node and install
        uses: ./.github/actions/node-setup-and-install

      - name: Run ESLint
        run: npm run lint

  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    needs:
      - lint
    env:
      CI: true
    outputs:
      coverage_lines: ${{ steps.coverage.outputs.lines }}
      coverage_statements: ${{ steps.coverage.outputs.statements }}
      coverage_branches: ${{ steps.coverage.outputs.branches }}
      coverage_functions: ${{ steps.coverage.outputs.functions }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node and install
        uses: ./.github/actions/node-setup-and-install

      - name: Run unit tests with coverage
        run: npm run test:coverage

      - name: Extract coverage summary
        id: coverage
        shell: bash
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            node --input-type=module <<'NODE' >> "$GITHUB_OUTPUT"
            import fs from 'node:fs';
            import path from 'node:path';

            const summaryPath = path.resolve('coverage/coverage-summary.json');
            const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8')).total;
            console.log(`lines=${summary.lines.pct}`);
            console.log(`statements=${summary.statements.pct}`);
            console.log(`branches=${summary.branches.pct}`);
            console.log(`functions=${summary.functions.pct}`);
NODE
          else
            echo 'lines=N/A' >> "$GITHUB_OUTPUT"
            echo 'statements=N/A' >> "$GITHUB_OUTPUT"
            echo 'branches=N/A' >> "$GITHUB_OUTPUT"
            echo 'functions=N/A' >> "$GITHUB_OUTPUT"
          fi

      - name: Upload unit coverage (HTML)
        if: ${{ hashFiles('coverage/**') != '' }}
        uses: actions/upload-artifact@v5
        with:
          name: unit-coverage-html
          path: coverage
          retention-days: 5

  e2e-tests:
    name: E2E tests
    runs-on: ubuntu-latest
    needs:
      - lint
    environment: integration
    outputs:
      coverage_lines: ${{ steps.coverage.outputs.lines }}
      coverage_statements: ${{ steps.coverage.outputs.statements }}
      coverage_branches: ${{ steps.coverage.outputs.branches }}
      coverage_functions: ${{ steps.coverage.outputs.functions }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node and install
        uses: ./.github/actions/node-setup-and-install

      - name: Install Playwright browsers
        shell: bash
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests (HTML report)
        run: npm run test:e2e -- --reporter=html
        env:
          CI: true
          PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.PUBLIC_SUPABASE_PUBLISHABLE_KEY }}
          SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_SECRET_KEY }}
          E2E_TEST_USER_EMAIL: ${{ secrets.E2E_TEST_USER_EMAIL }}
          E2E_TEST_USER_PASSWORD: ${{ secrets.E2E_TEST_USER_PASSWORD }}

      - name: Upload Playwright HTML report
        if: ${{ hashFiles('playwright-report/**') != '' }}
        uses: actions/upload-artifact@v5
        with:
          name: e2e-playwright-report
          path: playwright-report
          retention-days: 5

      - name: Extract E2E coverage summary
        id: coverage
        shell: bash
        run: |
          if [ -f coverage-e2e/coverage-summary.json ]; then
            node --input-type=module <<'NODE' >> "$GITHUB_OUTPUT"
            import fs from 'node:fs';
            import path from 'node:path';

            const summaryPath = path.resolve('coverage-e2e/coverage-summary.json');
            const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8')).total;
            console.log(`lines=${summary.lines.pct}`);
            console.log(`statements=${summary.statements.pct}`);
            console.log(`branches=${summary.branches.pct}`);
            console.log(`functions=${summary.functions.pct}`);
NODE
          else
            echo 'lines=N/A' >> "$GITHUB_OUTPUT"
            echo 'statements=N/A' >> "$GITHUB_OUTPUT"
            echo 'branches=N/A' >> "$GITHUB_OUTPUT"
            echo 'functions=N/A' >> "$GITHUB_OUTPUT"
          fi

      - name: Upload E2E coverage (if available)
        if: ${{ hashFiles('coverage-e2e/**') != '' }}
        uses: actions/upload-artifact@v5
        with:
          name: e2e-coverage
          path: coverage-e2e
          retention-days: 5

  status-comment:
    name: Status comment
    runs-on: ubuntu-latest
    needs:
      - lint
      - unit-tests
      - e2e-tests
    if: ${{ success() && github.event_name == 'pull_request' }}
    steps:
      - name: Comment overall status on PR
        uses: actions/github-script@v8
        with:
          script: |
            const unit = {
              lines: '${{ needs["unit-tests"].outputs.coverage_lines }}',
              statements: '${{ needs["unit-tests"].outputs.coverage_statements }}',
              branches: '${{ needs["unit-tests"].outputs.coverage_branches }}',
              functions: '${{ needs["unit-tests"].outputs.coverage_functions }}',
            };
            const e2e = {
              lines: '${{ needs["e2e-tests"].outputs.coverage_lines }}',
              statements: '${{ needs["e2e-tests"].outputs.coverage_statements }}',
              branches: '${{ needs["e2e-tests"].outputs.coverage_branches }}',
              functions: '${{ needs["e2e-tests"].outputs.coverage_functions }}',
            };
            const body = [
              'âœ… Lint, Unit tests, and E2E tests passed.',
              '',
              'Unit test coverage:',
              `- Lines: ${unit.lines}`,
              `- Statements: ${unit.statements}`,
              `- Branches: ${unit.branches}`,
              `- Functions: ${unit.functions}`,
              '',
              'E2E coverage:',
              `- Lines: ${e2e.lines}`,
              `- Statements: ${e2e.statements}`,
              `- Branches: ${e2e.branches}`,
              `- Functions: ${e2e.functions}`,
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

